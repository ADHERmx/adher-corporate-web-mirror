name: Mirror Repository

on:
  push:
    branches:
      - '**'  # Trigger on push to any branch

jobs:
  mirror:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for all branches
          fetch-tags: false  # Don't fetch tags as requested
          token: ${{ secrets.MIRROR_REPO_TOKEN }}  # Use PAT instead of default GITHUB_TOKEN
          persist-credentials: true  # Keep credentials for subsequent git operations

      - name: Debug - Verify token is set
        run: |
          if [ -z "${{ secrets.MIRROR_REPO_TOKEN }}" ]; then
            echo "❌ ERROR: MIRROR_REPO_TOKEN secret is not set!"
            exit 1
          else
            echo "✅ MIRROR_REPO_TOKEN secret is configured"
            echo "Token length: ${#MIRROR_TOKEN} characters"
          fi
        env:
          MIRROR_TOKEN: ${{ secrets.MIRROR_REPO_TOKEN }}

      - name: Configure Git
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Set up mirror remote
        env:
          MIRROR_TOKEN: ${{ secrets.MIRROR_REPO_TOKEN }}
        run: |
          # Add mirror repository as remote with PAT authentication
          git remote add mirror https://${MIRROR_TOKEN}@github.com/ADHERmx/adher-corporate-web-mirror.git

          echo "✅ Mirror remote configured"
          git remote -v

      - name: Fetch all branches locally
        run: |
          # Fetch all branches from origin
          git fetch origin --all

          # Create local tracking branches for all remote branches
          for branch in $(git branch -r | grep -v '\->'); do
            branch_name=${branch#origin/}
            if [ "$branch_name" != "HEAD" ]; then
              git branch --track "$branch_name" "$branch" 2>/dev/null || git branch -f "$branch_name" "$branch"
            fi
          done

          echo "✅ Local branches prepared:"
          git branch -a

      - name: Push all branches to mirror
        env:
          MIRROR_TOKEN: ${{ secrets.MIRROR_REPO_TOKEN }}
        run: |
          # Push all branches to mirror with force to ensure exact sync
          git push mirror --all --force

          echo "✅ Successfully mirrored all branches to ADHERmx/adher-corporate-web-mirror"

      - name: Mirror summary
        run: |
          echo "Repository mirroring complete!"
          echo "Source: Acabados-Adher-SA-de-CV/adher-corporate-web"
          echo "Mirror: ADHERmx/adher-corporate-web-mirror"
          echo "Branches synced:"
          git branch -r | grep 'origin/' | sed 's/origin\///' | sed 's/^/  - /'
